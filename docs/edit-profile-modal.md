# Модальное окно редактирования профиля

## Описание

Создано универсальное модальное окно для редактирования профиля пользователя и тренера с поддержкой загрузки файлов.

## Структура файлов

### Клиент

```
client/src/
├── features/
│   └── EditProfileModal/
│       ├── EditProfileModal.tsx     ✅ Компонент модалки
│       └── EditProfileModal.css     ✅ Стили
├── entities/
│   └── user/
│       ├── api/user.service.ts      ✅ Добавлен updateUser
│       └── model/
│           ├── user.thunk.ts        ✅ Добавлен updateUserThunk
│           └── user.slice.ts        ✅ Обработка update
└── pages/
    └── MyPage/MyPage.tsx            ✅ Интеграция модалки
```

### Сервер

```
server/src/
├── user/
│   └── user.controller.ts           ✅ Добавлен PUT /api/user/profile
└── trainer/
    └── trainer.controller.ts        ✅ Добавлен PUT /api/trainer/profile
```

## Использование

### В компоненте MyPage.tsx

```typescript
import EditProfileModal from '@/features/EditProfileModal/EditProfileModal';

function ProfilePage() {
  const [isModalOpen, setIsModalOpen] = useState(false);
  const currentUser = useAppSelector((state) => state.user.currentUser);
  const currentTrainer = useAppSelector((state) => state.trainer.authenticatedTrainer);
  
  const profileType = currentTrainer ? 'trainer' : 'user';
  const profileData = currentTrainer || currentUser;

  return (
    <>
      <button onClick={() => setIsModalOpen(true)}>
        Редактировать профиль
      </button>

      <EditProfileModal
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        profileType={profileType}
        currentData={profileData}
      />
    </>
  );
}
```

## API Endpoints

### PUT /api/user/profile

Обновление профиля пользователя

**Request:**
```json
{
  "name": "Новое имя",
  "email": "user@example.com"
}
```

**Response:**
```json
{
  "user": {
    "id": 1,
    "name": "Новое имя",
    "email": "user@example.com",
    "createdAt": "2026-01-20T...",
    "updatedAt": "2026-01-20T..."
  }
}
```

### PUT /api/trainer/profile

Обновление профиля тренера (multipart/form-data)

**Request:**
- name: string
- email: string
- description: string (optional)
- profileImage: File (optional)
- qualificationImages: File[] (optional, до 5 файлов)

**Response:**
```json
{
  "trainer": {
    "id": 1,
    "name": "Новое имя",
    "email": "trainer@example.com",
    "description": "Обновленное описание",
    "profileImage": "http://localhost:3000/uploads/profile/...",
    "qualificationImages": ["http://localhost:3000/uploads/qualifications/..."],
    "createdAt": "2026-01-20T...",
    "updatedAt": "2026-01-20T..."
  }
}
```

## Функциональность

### Для пользователя

- ✅ Изменение имени
- ✅ Изменение email
- ✅ Валидация полей
- ✅ Обработка ошибок
- ✅ Уведомление об успехе

### Для тренера

- ✅ Изменение имени
- ✅ Изменение email
- ✅ Изменение описания
- ✅ Обновление фото профиля
- ✅ Добавление новых сертификатов (до 5)
- ✅ Сохранение существующих сертификатов
- ✅ Валидация файлов
- ✅ Обработка ошибок
- ✅ Уведомление об успехе

## Особенности

### Модальное окно

- Закрывается по клику вне окна
- Закрывается по нажатию Escape
- Блокирует скролл страницы при открытии
- Анимация появления/исчезновения
- Адаптивный дизайн

### Загрузка файлов

- Поддержка drag & drop (через FileUploader)
- Предпросмотр выбранных файлов
- Валидация типов файлов
- Ограничение размера (5MB для фото, 10MB для сертификатов)
- Множественная загрузка сертификатов

### Обработка данных

- Автоматическое заполнение текущими данными
- Отправка только измененных полей
- Обработка FormData для файлов
- Парсинг JSON для qualificationImages
- Сохранение существующих сертификатов при добавлении новых

## Тестирование

### Сценарий 1: Обновление профиля пользователя

1. Войдите как пользователь
2. Перейдите на страницу профиля
3. Нажмите "Редактировать профиль"
4. Измените имя
5. Нажмите "Сохранить"
6. ✅ Профиль должен обновиться

### Сценарий 2: Обновление профиля тренера

1. Войдите как тренер
2. Перейдите на страницу профиля
3. Нажмите "Редактировать профиль"
4. Измените имя и описание
5. Загрузите новое фото профиля
6. Добавьте 2 новых сертификата
7. Нажмите "Сохранить"
8. ✅ Профиль должен обновиться с новыми данными

### Сценарий 3: Валидация

1. Откройте модалку редактирования
2. Очистите поле "Имя"
3. Попробуйте сохранить
4. ✅ Должна появиться ошибка валидации

### Сценарий 4: Закрытие модалки

1. Откройте модалку
2. Нажмите Escape
3. ✅ Модалка должна закрыться
4. Откройте снова
5. Кликните вне модалки
6. ✅ Модалка должна закрыться

## Возможные проблемы

### Проблема: TypeScript ошибка "has no exported member 'updateUserThunk'"

**Решение:**
1. Перезапустите TypeScript сервер в VS Code (Ctrl+Shift+P -> "TypeScript: Restart TS Server")
2. Или перезапустите клиент: `npm run dev`

### Проблема: Файлы не загружаются

**Решение:**
1. Проверьте, что FileUploader компонент существует
2. Проверьте размер файлов (не более 10MB)
3. Проверьте формат файлов (только изображения и PDF)

### Проблема: Сертификаты не добавляются

**Решение:**
1. Проверьте консоль браузера на ошибки
2. Проверьте, что сервер правильно обрабатывает FormData
3. Проверьте, что существующие сертификаты парсятся из JSON

### Проблема: Модалка не закрывается

**Решение:**
1. Проверьте, что onClose передается правильно
2. Проверьте, что нет ошибок в handleSubmit
3. Проверьте console.log для отладки

## Стилизация

Модалка использует следующие CSS классы:

- `.modal-overlay` - затемненный фон
- `.modal-content` - контейнер модалки
- `.modal-header` - заголовок с кнопкой закрытия
- `.modal-form` - форма редактирования
- `.modal-actions` - кнопки действий
- `.success-message` - сообщение об успехе
- `.error-message` - сообщение об ошибке

Можно кастомизировать через переопределение этих классов.

## Дальнейшие улучшения

1. **Валидация email** - проверка уникальности
2. **Удаление сертификатов** - возможность удалить существующие
3. **Кроппинг изображений** - обрезка перед загрузкой
4. **Прогресс загрузки** - показ процента загрузки файлов
5. **Предпросмотр** - показ текущих изображений в модалке
6. **Отмена изменений** - подтверждение при закрытии с несохраненными данными
7. **Автосохранение** - сохранение черновика в localStorage
8. **История изменений** - лог изменений профиля
